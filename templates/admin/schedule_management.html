{% extends 'admin/base.html' %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Quản lý lịch làm việc</li>
{% endblock %}

{% block admin_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span class="h5 mb-0">{{ current_date|date:"F Y" }}</span>
            <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-sm btn-outline-secondary ms-2">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
        {% if is_admin %}
        <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
            <i class="fas fa-plus me-1"></i> Thêm lịch làm việc
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        {% if is_admin %}
                        <th>Nhân viên</th>
                        {% endif %}
                        <th class="text-center">Thứ 2</th>
                        <th class="text-center">Thứ 3</th>
                        <th class="text-center">Thứ 4</th>
                        <th class="text-center">Thứ 5</th>
                        <th class="text-center">Thứ 6</th>
                        <th class="text-center">Thứ 7</th>
                        <th class="text-center">Chủ nhật</th>
                    </tr>
                </thead>
                <tbody>
                    {% if is_admin %}
                        {% for employee in staff %}
                            {% for week in weeks %}
                            <tr>
                                {% if forloop.first %}
                                <td rowspan="{{ weeks|length }}" style="vertical-align: middle;">{{ employee.ten_nv }}</td>
                                {% endif %}

                                {% for day in week %}
                                <td class="text-center {% if day and day.weekday >= 5 %}bg-light{% endif %}" style="height: 100px;">
                                    {% if day %}
                                        <div class="d-flex flex-column h-100">
                                            <div class="mb-1 small">{{ day.day }}</div>
                                            <div class="flex-grow-1">
                                                {% for schedule in schedules %}
                                                    {% if schedule.nhan_vien == employee and schedule.ngay_lam == day %}
                                                    <div class="p-1 mb-1 rounded schedule-item
                                                        {% if schedule.ca_lam == 'sang' %}bg-warning text-dark
                                                        {% elif schedule.ca_lam == 'chieu' %}bg-info text-dark
                                                        {% else %}bg-danger text-white{% endif %}">
                                                        <span class="schedule-short">
                                                            {% if schedule.ca_lam == 'sang' %}Sáng: 7h00-12h00
                                                            {% elif schedule.ca_lam == 'chieu' %}Chiều: 12h00-17h00
                                                            {% elif schedule.ca_lam == 'toi' %}Tối: 17h00-22h00
                                                            {% else %}Khuya: 22h-7h00{% endif %}
                                                        </span>
                                                        <a href="{% url 'delete_schedule' schedule.ma_lich %}" class="text-danger ms-1">
                                                            <i class="fas fa-times"></i>
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">Không có nhân viên nào đang làm việc.</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for week in weeks %}
                        <tr>
                            {% for day in week %}
                            <td class="text-center {% if day and day.weekday >= 5 %}bg-light{% endif %}" style="height: 100px;">
                                {% if day %}
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-1 small">{{ day.day }}</div>
                                        <div class="flex-grow-1">
                                            {% for schedule in schedules %}
                                                {% if schedule.ngay_lam == day %}
                                                <div class="p-1 mb-1 rounded schedule-item
                                                    {% if schedule.ca_lam == 'sang' %}bg-warning text-dark
                                                    {% elif schedule.ca_lam == 'chieu' %}bg-info text-dark
                                                    {% else %}bg-danger text-white{% endif %}">
                                                    <span class="schedule-short">
                                                        {% if schedule.ca_lam == 'sang' %}Sáng: 7h00-12h00
                                                        {% elif schedule.ca_lam == 'chieu' %}Chiều: 12h00-17h00
                                                        {% elif schedule.ca_lam == 'toi' %}Tối: 17h00-22h00
                                                        {% else %}Khuya: 22h-7h00{% endif %}
                                                    </span>
                                                    <span class="text-danger ms-1 disabled-link">
                                                        <i class="fas fa-times"></i>
                                                    </span>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Không có lịch làm việc nào trong tháng này.</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Thêm lịch làm việc (chỉ admin thấy) -->
{% if is_admin %}
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel">Thêm lịch làm việc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="addScheduleModalForm">
                {% csrf_token %}
                <div class="modal-body">
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger p-2" role="alert">
                            {% for error in form.non_field_errors %}
                                <small>{{ error }}</small><br>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="{{ form.nhan_vien.id_for_label }}" class="form-label">Nhân viên</label>
                        {{ form.nhan_vien }}
                        {% if form.nhan_vien.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.nhan_vien.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.ngay_lam.id_for_label }}" class="form-label">Ngày làm</label>
                        {{ form.ngay_lam }}
                        {% if form.ngay_lam.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ngay_lam.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.ca_lam.id_for_label }}" class="form-label">Ca làm</label>
                        {{ form.ca_lam }}
                        {% if form.ca_lam.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ca_lam.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.ghi_chu.id_for_label }}" class="form-label">Ghi chú <small class="text-muted">(tùy chọn)</small></label>
                        {{ form.ghi_chu }}
                        {% if form.ghi_chu.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ghi_chu.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save me-1"></i> Lưu lịch
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
    .table th, .table td {
        min-width: 80px;
        width: 80px;
        max-width: 80px;
        vertical-align: top;
        padding: 0.3rem;
    }
    .schedule-item {
        font-size: 0.7rem;
        margin-bottom: 1px;
        padding: 0.1rem 0.2rem !important;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .schedule-short {
        font-weight: bold;
    }
    .schedule-item .fa-times {
        font-size: 0.6rem;
    }
    .small {
        font-size: 0.8rem;
    }
    .table thead th {
        font-size: 0.8rem;
        padding: 0.5rem;
    }
    .disabled-link {
        pointer-events: none;
        color: grey;
        cursor: not-allowed;
        position: relative;
    }
    .disabled-link:hover::after {
        content: "Bạn không có quyền truy cập chức năng này.";
        position: absolute;
        background-color: #f8d7da;
        color: #721c24;
        padding: 5px 10px;
        border-radius: 4px;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modalForm = document.getElementById('addScheduleModalForm');
    if (modalForm) {
        modalForm.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="reset"]):not([type="button"]), select, textarea').forEach(function(element) {
            let elClassesToAdd = [];
            if (element.tagName.toLowerCase() === 'select') {
                elClassesToAdd = ['form-select', 'form-select-sm'];
            } else if (element.type === 'checkbox' || element.type === 'radio') {
                elClassesToAdd = ['form-check-input'];
            } else {
                elClassesToAdd = ['form-control', 'form-control-sm'];
            }

            elClassesToAdd.forEach(cls => {
                if (!element.classList.contains(cls)) {
                    element.classList.add(cls);
                }
            });

            if (element.name === 'ngay_lam' && element.getAttribute('type') !== 'date') {
                element.setAttribute('type', 'date');
            }
        });
    }

    document.querySelectorAll('.disabled-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Bạn không có quyền truy cập chức năng này.');
        });
    });
});
</script>
{% endblock %}